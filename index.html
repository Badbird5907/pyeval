<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script defer src="https://cdn.jsdelivr.net/pyodide/v0.22.1/full/pyodide.js"></script>
    <script defer>
      let setup = false
      let pyodide = null
      async function setup_pyodide() {
        if (!setup) {
          setup = true
          pyodide = await window.loadPyodide({
            indexURL: "https://cdn.jsdelivr.net/pyodide/v0.22.1/full/"
          });
        }
        // setup pyodide environment to run code blocks as needed
        const setup_code = `
import sys
import io
import traceback
import json

def run_code(code):
    """run specified code and return stdout, stderr, and error lines"""
    out = io.StringIO()
    oldout = sys.stdout
    olderr = sys.stderr
    sys.stdout = sys.stderr = out
    errors = []
    try:
        # change next line to exec(code, {}) if you want to clear vars each time
        exec(code, {})
    except:
        traceback.print_exc()
        errors = traceback.format_exc().splitlines()

    sys.stdout = oldout
    sys.stderr = olderr

    result = {
        "out": out.getvalue().splitlines(),
        "errors": [i+1 for i, line in enumerate(out.getvalue().splitlines()) if line.startswith("Traceback")],
    }
    return json.dumps(result)
`
        return await pyodide.runPythonAsync(setup_code)
      }

      async function runPython(code) {
        await setup_pyodide()
        const c = JSON.stringify(code);
        console.log({ c })
        const result = await pyodide.runPythonAsync(`run_code(${c})`)
        console.log({ result })
        return result;
      }
    </script>
    <title>PyEval</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
